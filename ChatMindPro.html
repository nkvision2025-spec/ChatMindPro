<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mind Pro - Advanced Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-dark: #080c14;
            --bg-card: #0f172a;
            --accent: #2563eb;
            --border: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
            margin: 0;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }

        .btn-primary {
            background-color: var(--accent);
            transition: all 0.2s;
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.39);
        }
        .btn-primary:hover { background-color: #3b82f6; transform: translateY(-1px); }
        
        .glass-header {
            background: rgba(11, 17, 32, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
        }

        .chat-bubble-user {
            background-color: var(--accent);
            border-radius: 1.5rem 1.5rem 0.2rem 1.5rem;
        }

        .chat-bubble-ai {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1.5rem 1.5rem 1.5rem 0.2rem;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
        }

        .hidden-element { display: none !important; }
        
        .tab-active { background-color: var(--accent) !important; color: white !important; }

        .typing-dot {
            width: 4px; height: 4px; background: #94a3b8; border-radius: 50%;
            animation: typing 1s infinite ease-in-out;
        }
        @keyframes typing {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .source-tag {
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .msg-checkbox {
            opacity: 0.1;
            transition: opacity 0.2s;
        }
        .group:hover .msg-checkbox {
            opacity: 1;
        }
        .msg-checkbox.is-selected {
            opacity: 1;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Auth Modal -->
    <div id="login-modal" class="fixed inset-0 z-[60] flex items-center justify-center modal-overlay">
        <div class="bg-[#0f172a] p-8 rounded-3xl border border-slate-800 w-full max-w-md shadow-2xl">
            <div class="flex flex-col items-center mb-8">
                <div class="text-blue-500 mb-4">
                    <i data-lucide="brain-circuit" class="w-12 h-12"></i>
                </div>
                <h2 class="text-2xl font-bold uppercase tracking-widest text-center">AI Mind Pro</h2>
                <p class="text-slate-500 text-sm mt-1">Please login to continue</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Username</label>
                    <input id="login-username" type="text" placeholder="admin or user" class="w-full bg-[#070b14] border border-slate-800 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Password</label>
                    <input id="login-password" type="password" placeholder="••••••••" class="w-full bg-[#070b14] border border-slate-800 rounded-xl p-3 text-sm focus:border-blue-500 outline-none">
                </div>
                <button onclick="handleLogin()" class="w-full btn-primary text-white font-bold py-3 rounded-xl uppercase tracking-widest mt-4">Login</button>
                <div id="login-error" class="text-red-500 text-xs text-center hidden-element">Invalid credentials</div>
            </div>
        </div>
    </div>

    <!-- Instruction Modal -->
    <div id="instruction-modal" class="fixed inset-0 z-[70] flex items-center justify-center modal-overlay hidden-element">
        <div class="bg-[#0f172a] p-8 rounded-3xl border border-slate-800 w-full max-w-xl shadow-2xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="file-cog" class="w-5 h-5 text-blue-500"></i>
                    Document Instructions
                </h3>
                <button onclick="closeInstructionModal()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <p id="inst-doc-name" class="text-sm text-slate-400 mb-4 font-mono"></p>
            <textarea id="doc-instruction-text" class="w-full h-48 bg-[#070b14] border border-slate-800 rounded-xl p-4 text-sm text-slate-300 focus:border-blue-500 outline-none resize-none" placeholder="Enter specific instructions for this document..."></textarea>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeInstructionModal()" class="px-6 py-2 text-sm font-bold text-slate-400 hover:text-white">Cancel</button>
                <button onclick="saveDocInstruction()" class="px-8 py-2 btn-primary rounded-xl text-sm font-bold text-white uppercase tracking-wider">Save Instruction</button>
            </div>
        </div>
    </div>

    <!-- Main UI -->
    <div id="app-content" class="h-screen flex overflow-hidden hidden-element">
        
        <aside class="w-80 border-r border-slate-800 flex flex-col bg-[#080c14] shrink-0">
            <div class="p-6 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="text-blue-500"><i data-lucide="brain-circuit" class="w-7 h-7"></i></div>
                    <h1 class="text-lg font-bold tracking-tight uppercase">AI Mind Pro</h1>
                </div>
                <button onclick="handleLogout()" class="text-xs font-semibold text-red-400 border border-red-900/50 px-3 py-1.5 rounded-lg hover:bg-red-900/20 transition-colors">
                    LOGOUT
                </button>
            </div>

            <div class="px-4 py-2 space-y-6 overflow-y-auto custom-scrollbar flex-1">
                <!-- Admin Panel -->
                <section id="admin-management-section" class="hidden-element">
                    <div class="flex items-center gap-2 mb-3 text-slate-500 text-[10px] font-bold uppercase tracking-widest px-2">
                        <i data-lucide="shield-check" class="w-3.5 h-3.5"></i> Admin Management
                    </div>
                    <div class="bg-[#0f172a] rounded-xl p-4 border border-slate-800 space-y-4">
                        <div>
                            <p class="text-[10px] text-slate-500 mb-2 uppercase">Create User</p>
                            <input id="new-user-id" type="text" placeholder="User ID" class="w-full bg-[#070b14] border border-slate-800 rounded-lg p-2 text-xs mb-2 outline-none">
                            <input id="new-user-pass" type="password" placeholder="Password" class="w-full bg-[#070b14] border border-slate-800 rounded-lg p-2 text-xs mb-2 outline-none">
                            <button onclick="addUser()" class="w-full text-[10px] font-bold py-2 rounded bg-blue-600 hover:bg-blue-500 uppercase transition-all">Add User</button>
                        </div>
                        <div class="pt-2 border-t border-slate-800">
                            <p class="text-[10px] text-slate-500 mb-2 uppercase">Manage Users</p>
                            <div id="admin-user-list" class="space-y-1 max-h-32 overflow-y-auto custom-scrollbar text-[10px]"></div>
                        </div>
                        <div class="pt-2 border-t border-slate-800">
                            <p class="text-[10px] text-slate-500 mb-1 uppercase">Upload New Doc</p>
                            <input type="file" id="doc-upload" class="hidden" onchange="handleFileUpload(event)">
                            <button onclick="document.getElementById('doc-upload').click()" class="w-full text-[10px] font-bold py-2 rounded border border-blue-500/50 text-blue-400 uppercase">Select File</button>
                        </div>
                    </div>
                </section>

                <!-- Knowledge Base -->
                <section>
                    <div class="flex items-center justify-between mb-3 px-2">
                        <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest">Active Documents</div>
                        <span id="active-count" class="text-[10px] font-bold text-blue-500 bg-blue-500/10 px-2 py-0.5 rounded-full">0 Selected</span>
                    </div>
                    <div id="doc-list" class="space-y-2"></div>
                </section>

                <!-- Response Mode -->
                <section>
                    <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-3 px-2">Response Mode</div>
                    <div class="flex bg-[#070b14] p-1 rounded-xl border border-slate-800">
                        <button onclick="setMode('doc')" id="mode-doc" class="flex-1 py-2 text-[10px] font-bold rounded-lg tab-active transition-all">DOC</button>
                        <button onclick="setMode('web')" id="mode-web" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-slate-500 hover:text-slate-300 transition-all">WEB</button>
                        <button onclick="setMode('both')" id="mode-both" class="flex-1 py-2 text-[10px] font-bold rounded-lg text-slate-500 hover:text-slate-300 transition-all">BOTH</button>
                    </div>
                </section>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative bg-[#0b1120]">
            <header class="h-16 glass-header flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full bg-green-500"></span>
                        <div class="leading-tight">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">Active User</div>
                            <div id="active-user-display" class="text-sm font-bold">...</div>
                        </div>
                    </div>
                    <div class="h-8 w-px bg-slate-800 mx-2"></div>
                    
                    <button onclick="handleBulkDelete()" class="text-[10px] font-bold text-slate-400 hover:text-red-400 uppercase transition-colors px-3 py-1 border border-slate-800 rounded">
                        Delete
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Export:</span>
                        <button onclick="handleBulkExport('pdf')" class="text-[10px] font-bold text-slate-400 hover:text-blue-400 uppercase transition-colors px-2 py-1 border border-slate-800 rounded">PDF</button>
                        <button onclick="handleBulkExport('docx')" class="text-[10px] font-bold text-slate-400 hover:text-blue-400 uppercase transition-colors px-2 py-1 border border-slate-800 rounded">DOCX</button>
                        <button onclick="handleBulkExport('txt')" class="text-[10px] font-bold text-slate-400 hover:text-blue-400 uppercase transition-colors px-2 py-1 border border-slate-800 rounded">TXT</button>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="toggleSelectAll()" class="text-[10px] font-bold text-slate-500 hover:text-white uppercase px-3 py-1 border border-slate-800 rounded">Toggle All</button>
                </div>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                <div class="flex justify-center text-slate-500 text-xs italic">System: AI Mind Pro is ready. Select documents to start grounding.</div>
            </div>

            <div id="typing-indicator" class="px-8 py-2 hidden-element">
                <div class="flex items-center gap-2 text-slate-500 text-xs">
                    <div class="flex gap-1">
                        <div class="typing-dot" style="animation-delay: 0s"></div>
                        <div class="typing-dot" style="animation-delay: 0.2s"></div>
                        <div class="typing-dot" style="animation-delay: 0.4s"></div>
                    </div>
                    <span>AI is processing grounding docs...</span>
                </div>
            </div>

            <div class="p-6">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-[#0f172a] rounded-[2rem] p-3 border border-slate-800 flex items-center gap-3 shadow-xl focus-within:ring-2 ring-blue-500/50 transition-all">
                        <button onclick="startVoiceInput()" id="mic-btn" class="p-3 text-slate-400 hover:text-blue-400 transition-colors">
                            <i data-lucide="mic" class="w-6 h-6"></i>
                        </button>
                        <input id="chat-input" type="text" placeholder="Apna sawal yahan likhein..." class="flex-1 bg-transparent border-none text-slate-200 focus:ring-0 placeholder-slate-600 outline-none">
                        <button id="send-btn" onclick="sendMessage()" class="w-12 h-12 rounded-full btn-primary flex items-center justify-center text-white">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full text-sm font-medium shadow-2xl transition-all duration-300 translate-y-20 opacity-0 pointer-events-none z-[100]">
        Success
    </div>

    <script>
        // --- STATE ---
        const apiKey = ""; 
        let currentUser = null;
        let activeMode = 'doc';
        let currentEditingDocId = null;
        
        let systemUsers = JSON.parse(localStorage.getItem('aimind_users')) || [
            { id: 'admin', pass: 'admin123', role: 'admin' },
            { id: 'user', pass: 'user123', role: 'user' }
        ];

        let documents = JSON.parse(localStorage.getItem('aimind_docs')) || [
            { id: 1, name: 'General Guide.pdf', access: 'all', instruction: 'Professional consultant style.', isActive: true },
            { id: 2, name: 'Tech Specs.doc', access: 'admin', instruction: 'Highly technical.', isActive: false }
        ];
        
        let chatMessages = []; 
        let isSpeaking = false;
        let synth = window.speechSynthesis;
        let recognition = null;

        lucide.createIcons();

        // --- AUTH ---
        function handleLogin() {
            const uInput = document.getElementById('login-username');
            const pInput = document.getElementById('login-password');
            const u = uInput.value.trim();
            const p = pInput.value.trim();
            const found = systemUsers.find(x => x.id === u && x.pass === p);

            if (found) {
                currentUser = found;
                document.getElementById('login-modal').classList.add('hidden-element');
                document.getElementById('app-content').classList.remove('hidden-element');
                document.getElementById('active-user-display').innerText = currentUser.id.toUpperCase();
                
                const adminSection = document.getElementById('admin-management-section');
                if (currentUser.role === 'admin') {
                    adminSection.classList.remove('hidden-element');
                } else {
                    adminSection.classList.add('hidden-element');
                }

                uInput.value = '';
                pInput.value = '';
                document.getElementById('login-error').classList.add('hidden-element');

                renderUserList();
                renderDocs();
                showToast("Logged in successfully!");
            } else {
                document.getElementById('login-error').classList.remove('hidden-element');
            }
        }

        function handleLogout() {
            currentUser = null;
            document.getElementById('app-content').classList.add('hidden-element');
            document.getElementById('login-modal').classList.remove('hidden-element');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            chatMessages = [];
            document.getElementById('chat-window').innerHTML = '';
        }

        // --- ADMIN PANEL ---
        function renderUserList() {
            const list = document.getElementById('admin-user-list');
            if (!list) return;
            list.innerHTML = '';
            systemUsers.forEach(u => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-[#070b14] rounded-lg border border-slate-800 mb-1';
                item.innerHTML = `<span>${u.id}</span>${u.role !== 'admin' ? `<button onclick="deleteUser('${u.id}')" class="text-red-500 hover:text-red-400 transition-colors"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : ''}`;
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function addUser() {
            const id = document.getElementById('new-user-id').value.trim();
            const pass = document.getElementById('new-user-pass').value.trim();
            if (!id || !pass) return showToast("Details missing!");
            if (systemUsers.find(u => u.id === id)) return showToast("User ID already exists!");
            
            systemUsers.push({ id, pass, role: 'user' });
            localStorage.setItem('aimind_users', JSON.stringify(systemUsers));
            renderUserList();
            renderDocs(); 
            document.getElementById('new-user-id').value = '';
            document.getElementById('new-user-pass').value = '';
            showToast("User added!");
        }

        function deleteUser(id) {
            systemUsers = systemUsers.filter(x => x.id !== id);
            localStorage.setItem('aimind_users', JSON.stringify(systemUsers));
            renderUserList();
            renderDocs();
            showToast("User removed.");
        }

        // --- DOCUMENTS ---
        function handleFileUpload(e) {
            const f = e.target.files[0];
            if (f) {
                documents.push({ id: Date.now(), name: f.name, access: 'all', instruction: '', isActive: true });
                saveDocs();
                showToast("File uploaded.");
            }
        }

        function saveDocs() {
            localStorage.setItem('aimind_docs', JSON.stringify(documents));
            renderDocs();
        }

        function toggleDocActive(id) {
            const d = documents.find(x => x.id === id);
            if (d) { d.isActive = !d.isActive; saveDocs(); }
        }

        function updateDocAccess(id, val) {
            const d = documents.find(x => x.id === id);
            if (d) { d.access = val; saveDocs(); }
        }

        function openInstructionModal(id) {
            currentEditingDocId = id;
            const d = documents.find(x => x.id === id);
            document.getElementById('inst-doc-name').innerText = d.name;
            document.getElementById('doc-instruction-text').value = d.instruction || '';
            document.getElementById('instruction-modal').classList.remove('hidden-element');
        }

        function closeInstructionModal() { document.getElementById('instruction-modal').classList.add('hidden-element'); }

        function saveDocInstruction() {
            const d = documents.find(x => x.id === currentEditingDocId);
            if (d) { d.instruction = document.getElementById('doc-instruction-text').value; saveDocs(); }
            closeInstructionModal();
        }

        // New function to delete a document
        function deleteDoc(id) {
            documents = documents.filter(d => d.id !== id);
            saveDocs();
            showToast("Document delete ho gaya.");
        }

        function renderDocs() {
            const list = document.getElementById('doc-list');
            if (!list) return;
            list.innerHTML = '';
            const visible = currentUser.role === 'admin' ? documents : documents.filter(d => d.access === 'all' || d.access === currentUser.id);
            let count = 0;
            visible.forEach(d => {
                if (d.isActive) count++;
                const item = document.createElement('div');
                item.className = `bg-[#070b14] rounded-xl border ${d.isActive ? 'border-blue-600/50' : 'border-slate-800'} p-3 transition-all mb-2`;
                
                let accessControl = '';
                if (currentUser.role === 'admin') {
                    let opts = `<option value="all" ${d.access === 'all' ? 'selected' : ''}>All Users</option>`;
                    systemUsers.forEach(u => opts += `<option value="${u.id}" ${d.access === u.id ? 'selected' : ''}>${u.id}</option>`);
                    accessControl = `<div class="mt-2 pt-2 border-t border-slate-800 flex justify-between items-center"><span class="text-[9px] text-slate-500 uppercase font-bold">Assign to:</span><select onchange="updateDocAccess(${d.id}, this.value)" class="bg-transparent text-[10px] text-blue-400 outline-none">${opts}</select></div>`;
                }

                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <input type="checkbox" ${d.isActive ? 'checked' : ''} onclick="toggleDocActive(${d.id})" class="w-4 h-4 rounded bg-slate-900 border-slate-700 text-blue-600">
                            <span class="text-xs font-medium truncate ${d.isActive ? 'text-blue-400' : 'text-slate-400'} text-left">${d.name}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <button onclick="openInstructionModal(${d.id})" class="p-1 hover:text-blue-400 text-slate-500 transition-colors"><i data-lucide="cog" class="w-3.5 h-3.5"></i></button>
                            <button onclick="deleteDoc(${d.id})" class="p-1 hover:text-red-400 text-slate-500 transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                        </div>
                    </div>
                    ${accessControl}
                `;
                list.appendChild(item);
            });
            document.getElementById('active-count').innerText = `${count} Selected`;
            lucide.createIcons();
        }

        // --- CHAT & AI ---
        async function sendMessage() {
            const iInput = document.getElementById('chat-input');
            const val = iInput.value.trim();
            if (!val) return;
            
            const newMessage = { id: String(Date.now() + Math.random()), text: val, sender: 'user', selected: false };
            chatMessages.push(newMessage);
            renderMessage(newMessage);
            
            iInput.value = '';
            document.getElementById('typing-indicator').classList.remove('hidden-element');
            
            try {
                const responseData = await callGemini(val);
                document.getElementById('typing-indicator').classList.add('hidden-element');
                const aiMsg = { 
                    id: String(Date.now() + Math.random()), 
                    text: responseData.text, 
                    sender: 'ai', 
                    selected: false,
                    source: responseData.source 
                };
                chatMessages.push(aiMsg);
                renderMessage(aiMsg);
            } catch (e) {
                document.getElementById('typing-indicator').classList.add('hidden-element');
                const errorMsg = { id: String(Date.now() + Math.random()), text: "Galti ho gayi. Kripya dubara koshish karein.", sender: 'ai', selected: false };
                chatMessages.push(errorMsg);
                renderMessage(errorMsg);
            }
        }

        async function callGemini(p) {
            const activeDocs = documents.filter(d => d.isActive);
            const context = activeDocs.map(d => `File: ${d.name}\nInstruction: ${d.instruction}`).join('\n');
            
            const systemPrompt = `Role: AI Mind Pro. Use Active Docs Context:\n${context || "No context provided."}\nLang: Same as user query. Mode: ${activeMode.toUpperCase()}.`;
            
            const payload = {
                contents: [{ parts: [{ text: p }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            if (activeMode === 'web' || activeMode === 'both') {
                payload.tools = [{ "google_search": {} }];
            }

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Mafi chahte hain, jawab nahi mila.";
            
            return {
                text: text,
                source: activeMode.toUpperCase()
            };
        }

        function renderMessage(m) {
            const win = document.getElementById('chat-window');
            const wrap = document.createElement('div');
            wrap.id = `msg-wrap-${m.id}`;
            wrap.className = `flex ${m.sender === 'user' ? 'justify-end' : 'justify-start'} mb-4 items-start gap-4 group`;
            
            const check = `<div class="msg-checkbox pt-4 transition-all ${m.selected ? 'is-selected' : ''}"><input type="checkbox" onchange="toggleMsgSelect('${m.id}')" id="msg-check-${m.id}" ${m.selected ? 'checked' : ''} class="w-4 h-4 rounded border-slate-700 bg-slate-900 text-blue-600"></div>`;
            
            let sourceTag = '';
            if (m.sender === 'ai' && m.source) {
                let icon = 'file-text';
                if (m.source === 'WEB') icon = 'globe';
                if (m.source === 'BOTH') icon = 'layers';
                sourceTag = `
                    <div class="source-tag">
                        <i data-lucide="${icon}" class="w-3 h-3"></i>
                        Source: ${m.source}
                    </div>
                `;
            }

            wrap.innerHTML = `
                ${m.sender === 'ai' ? check : ''}
                <div class="max-w-[75%] flex flex-col ${m.sender === 'user' ? 'items-end' : 'items-start'}">
                    <div class="${m.sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-ai'} px-6 py-4 text-sm shadow-lg whitespace-pre-wrap">
                        ${m.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}
                        ${m.sender === 'ai' ? `
                            <div class="mt-3 pt-3 border-t border-slate-800 flex gap-4">
                                <button onclick="toggleSpeech('${m.id}', this)" class="text-slate-500 hover:text-blue-400 transition-colors"><i data-lucide="volume-2" class="w-4 h-4"></i></button>
                                <button onclick="copyMsg('${m.id}')" class="text-slate-500 hover:text-blue-400 transition-colors"><i data-lucide="copy" class="w-4 h-4"></i></button>
                            </div>
                        ` : ''}
                    </div>
                    ${sourceTag}
                </div>
                ${m.sender === 'user' ? check : ''}
            `;
            win.appendChild(wrap);
            win.scrollTop = win.scrollHeight;
            lucide.createIcons();
        }

        function toggleMsgSelect(id) { 
            const m = chatMessages.find(x => x.id === id); 
            if (m) {
                m.selected = !m.selected;
                const wrap = document.getElementById(`msg-wrap-${id}`);
                const checkboxContainer = wrap.querySelector('.msg-checkbox');
                if (m.selected) {
                    checkboxContainer.classList.add('is-selected');
                } else {
                    checkboxContainer.classList.remove('is-selected');
                }
            }
        }

        function handleBulkDelete() {
            const selectedCount = chatMessages.filter(m => m.selected).length;
            if (selectedCount === 0) return showToast("Delete karne ke liye messages select karein.");
            
            chatMessages = chatMessages.filter(m => !m.selected);
            refreshChatUI();
            showToast(`${selectedCount} Messages delete ho gaye.`);
        }

        function refreshChatUI() {
            const win = document.getElementById('chat-window');
            win.innerHTML = '';
            if (chatMessages.length === 0) {
                win.innerHTML = '<div class="flex justify-center text-slate-500 text-xs italic">System: Chat cleared.</div>';
            } else {
                chatMessages.forEach(m => renderMessage(m));
            }
        }

        function handleBulkExport(type) {
            const sel = chatMessages.filter(m => m.selected);
            const list = sel.length > 0 ? sel : chatMessages;
            
            if (list.length === 0) return showToast("Export karne ke liye koi message nahi hai.");

            let exportStr = `--- AI MIND PRO CHAT EXPORT ---\n`;
            exportStr += `Generated: ${new Date().toLocaleString()}\n`;
            exportStr += `--------------------------------\n\n`;

            list.forEach((m) => {
                const role = m.sender === 'user' ? "USER" : "AI MIND PRO";
                const sourceInfo = m.source ? ` (Source: ${m.source})` : "";
                exportStr += `[${role}${sourceInfo}]\n${m.text}\n\n`;
                exportStr += `--------------------------------\n\n`;
            });

            if (type === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const margin = 10;
                let cursorY = 20;
                pdf.setFontSize(14);
                pdf.text("AI MIND PRO CHAT EXPORT", margin, 10);
                pdf.setFontSize(10);
                
                const lines = pdf.splitTextToSize(exportStr, 180);
                lines.forEach(line => {
                    if (cursorY > 280) {
                        pdf.addPage();
                        cursorY = 20;
                    }
                    pdf.text(line, margin, cursorY);
                    cursorY += 6;
                });
                pdf.save(`Chat_Export_${Date.now()}.pdf`);
            } else if (type === 'docx') {
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export</title></head><body>";
                const footer = "</body></html>";
                const content = exportStr.split('\n').map(l => l.trim() === "" ? "<br>" : `<p style="margin-bottom:10pt">${l}</p>`).join('');
                const html = header + content + footer;
                const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `Chat_Export_${Date.now()}.docx`;
                a.click();
            } else {
                const blob = new Blob([exportStr], { type: 'text/plain;charset=utf-8' }); 
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                a.download = `Chat_Export_${Date.now()}.txt`; 
                a.click();
            }
            showToast(`${type.toUpperCase()} export download ho raha hai.`);
        }

        function toggleSelectAll() {
            const allSelected = chatMessages.length > 0 && chatMessages.every(m => m.selected);
            chatMessages.forEach(m => {
                m.selected = !allSelected;
                const el = document.getElementById(`msg-check-${m.id}`);
                if (el) el.checked = !allSelected;
                
                const wrap = document.getElementById(`msg-wrap-${m.id}`);
                if (wrap) {
                    const checkboxContainer = wrap.querySelector('.msg-checkbox');
                    if (m.selected) checkboxContainer.classList.add('is-selected');
                    else checkboxContainer.classList.remove('is-selected');
                }
            });
        }

        // --- UTILS ---
        function toggleSpeech(id, btn) {
            const m = chatMessages.find(x => x.id === id);
            if (!m) return;
            
            if (isSpeaking) { synth.cancel(); isSpeaking = false; btn.innerHTML = '<i data-lucide="volume-2" class="w-4 h-4"></i>'; }
            else {
                const utter = new SpeechSynthesisUtterance(m.text);
                utter.onend = () => { isSpeaking = false; btn.innerHTML = '<i data-lucide="volume-2" class="w-4 h-4"></i>'; lucide.createIcons(); };
                synth.speak(utter); isSpeaking = true; btn.innerHTML = '<i data-lucide="square" class="w-4 h-4 text-red-500"></i>';
            }
            lucide.createIcons();
        }

        function copyMsg(id) {
            const m = chatMessages.find(x => x.id === id);
            if (!m) return;
            const area = document.createElement("textarea"); 
            area.value = m.text;
            area.style.position = "fixed"; area.style.left = "-9999px"; 
            document.body.appendChild(area);
            area.select(); document.execCommand('copy'); 
            document.body.removeChild(area);
            showToast("Clipboard mein copy ho gaya!");
        }

        function startVoiceInput() {
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SR) return showToast("Mic support nahi hai.");
            recognition = new SR(); recognition.lang = 'hi-IN'; recognition.start();
            document.getElementById('mic-btn').classList.add('text-red-500', 'animate-pulse');
            recognition.onresult = (e) => { document.getElementById('chat-input').value = e.results[0][0].transcript; sendMessage(); };
            recognition.onend = () => document.getElementById('mic-btn').classList.remove('text-red-500', 'animate-pulse');
        }

        function setMode(m) { 
            activeMode = m; 
            ['doc', 'web', 'both'].forEach(x => {
                const el = document.getElementById(`mode-${x}`);
                if (el) el.classList.remove('tab-active'); 
            });
            const activeEl = document.getElementById(`mode-${m}`);
            if (activeEl) activeEl.classList.add('tab-active'); 
        }

        function showToast(m) { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            t.classList.remove('translate-y-20', 'opacity-0'); 
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); 
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>