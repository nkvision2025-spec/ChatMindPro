<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MIND PRO - Multilingual Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0b1120; color: #94a3b8; font-family: sans-serif; }
        .sidebar { background-color: #0f172a; border-right: 1px solid #1e293b; width: 320px; }
        .card { background-color: #111827; border: 1px solid #1e293b; border-radius: 12px; }
        .input-dark { background-color: #020617; border: 1px solid #1e293b; color: #f8fafc; }
        .btn-primary { background-color: #3b82f6; color: white; transition: all 0.3s; }
        .response-mode-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .msg-selected { border: 2px solid #3b82f6 !important; background: rgba(59, 130, 246, 0.05); }
        .modal-bg { background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); }
        .animate-fadeIn { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="sidebar flex flex-col p-4 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg text-white"><i class="fas fa-brain"></i></div>
                <h1 class="text-xl font-bold text-white tracking-tight uppercase">AI MIND PRO</h1>
            </div>
            <button class="text-[10px] font-bold text-red-500 border border-red-500/30 px-3 py-1 rounded">LOGOUT</button>
        </div>

        <!-- API Settings Toggle -->
        <div id="apiToggleBtn" class="border border-gray-700 rounded-full py-2 px-4 mb-4 text-center cursor-pointer hover:bg-gray-800 text-blue-400 font-bold text-xs uppercase">
            <i class="fas fa-sliders-h mr-2"></i> API Settings
        </div>

        <div id="apiSettingsPanel" class="hidden mb-6 p-4 card space-y-3">
            <div>
                <label class="text-[10px] text-gray-400 block mb-1 uppercase">OpenRouter Key</label>
                <input type="password" id="apiKeyInput" class="input-dark w-full p-2 text-sm rounded outline-none">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 block mb-1 uppercase">Select Reliable Model</label>
                <select id="modelSelect" class="input-dark w-full p-2 text-[11px] rounded outline-none">
                    <!-- High Quality Paid/Limited -->
                    <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash (GUJ/HIN/ENG - High Speed)</option>
                    
                    <!-- Best Free Models for PDF & Web -->
                    <option value="google/gemini-2.0-pro-exp-02-05:free">Gemini 2.0 Pro (GUJ/HIN/ENG - Best for Complex PDF)</option>
                    <option value="qwen/qwen-2.5-72b-instruct:free">Qwen 2.5 72B (GUJ/HIN/ENG - Very Stable)</option>
                    <option value="deepseek/deepseek-chat:free">DeepSeek V3 (GUJ/HIN/ENG - Smart Reasoning)</option>
                    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (ENG - Basic Processing)</option>
                </select>
            </div>
            <button id="saveConfig" class="w-full text-xs font-bold py-2 bg-blue-600 text-white rounded uppercase">Save Settings</button>
        </div>

        <!-- Documents Management -->
        <div class="mb-6">
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Documents Management</p>
            <div class="card p-4 border-dashed border-gray-700 flex flex-col items-center">
                <input type="file" id="pdfUpload" accept=".pdf" class="hidden">
                <label for="pdfUpload" class="cursor-pointer text-center group">
                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2 group-hover:scale-110 transition"></i>
                    <p class="text-[10px] text-gray-400 uppercase font-bold tracking-tighter">Upload PDF / DOC</p>
                </label>
            </div>
        </div>

        <!-- Active Documents List -->
        <div>
            <p class="text-[10px] text-gray-400 uppercase font-bold mb-2">Active Files</p>
            <div class="card p-2 space-y-2" id="docList">
                <p class="text-[10px] text-gray-600 text-center italic py-2">No files active</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
        <nav class="h-16 flex items-center justify-between px-6 border-b border-gray-800 bg-gray-900/20">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-500 uppercase tracking-widest">Active User</span>
                    <span id="activeUserDisplay" class="text-sm font-bold text-white uppercase tracking-wider">ADMIN</span>
                </div>
                
                <!-- Response Modes -->
                <div class="flex gap-1 bg-gray-900 p-1 rounded-lg ml-6">
                    <button class="response-mode-btn active text-[10px] px-4 py-1.5 rounded font-bold transition uppercase" onclick="setMode(this, 'DOC')">DOC</button>
                    <button class="response-mode-btn text-[10px] px-4 py-1.5 rounded text-gray-500 font-bold hover:text-white transition uppercase" onclick="setMode(this, 'WEB')">WEB</button>
                    <button class="response-mode-btn text-[10px] px-4 py-1.5 rounded text-gray-500 font-bold hover:text-white transition uppercase" onclick="setMode(this, 'BOTH')">BOTH</button>
                </div>

                <button id="deleteSelected" class="ml-4 bg-red-900/10 text-red-500 border border-red-500/20 text-[10px] font-bold px-3 py-1.5 rounded uppercase hover:bg-red-500 hover:text-white transition">Delete Selected</button>
            </div>
        </nav>

        <!-- Chat Area -->
        <div id="chatWindow" class="flex-1 overflow-y-auto p-8 flex flex-col gap-6">
            <div class="text-center p-10 opacity-30 mt-20">
                <i class="fas fa-layer-group text-5xl mb-4"></i>
                <p class="text-sm font-bold uppercase tracking-widest">AI Mind Pro Ready</p>
                <p class="text-[10px] mt-2">PDF પ્રોસેસિંગ માટે Gemini 2.0 (Free) મોડલ શ્રેષ્ઠ છે.</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="p-6">
            <div class="max-w-4xl mx-auto chat-input-container p-2 flex items-center gap-4 px-4 shadow-2xl bg-gray-900/80 border border-gray-800 rounded-full">
                <button id="voiceInputBtn" class="text-gray-500 hover:text-blue-500 transition text-lg px-2" title="Voice Typing">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" id="mainInput" placeholder="તમારો સવાલ અહીં લખો..." class="flex-1 bg-transparent border-none outline-none text-white text-sm py-2">
                <button id="sendBtn" class="bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-blue-500 transition shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Modal for Instructions -->
    <div id="instrModal" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50">
        <div class="card w-[450px] p-6 shadow-2xl border-blue-500/30">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white font-bold uppercase text-xs tracking-widest">File Instructions</h3>
                <i class="fas fa-times text-gray-500 cursor-pointer hover:text-white" onclick="closeInstrModal()"></i>
            </div>
            <p id="instrFileName" class="text-[10px] text-blue-400 font-bold mb-2 truncate"></p>
            <textarea id="instrText" class="input-dark w-full h-32 rounded p-3 text-sm mb-4 outline-none focus:border-blue-500" placeholder="AI ને આ ફાઈલ વિશે કોઈ ખાસ સૂચના આપો..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="saveInstructions()" class="text-[11px] px-6 py-2 bg-blue-600 text-white rounded-full uppercase font-bold">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let config = {
            apiKey: localStorage.getItem('or_key') || '',
            modelId: localStorage.getItem('or_model') || 'google/gemini-2.0-flash-001',
            mode: 'DOC'
        };

        let uploadedDocs = []; 
        let selectedMessages = new Set();
        let recognition;
        let currentInstrIdx = -1;
        let isListening = false;

        // --- PDF Processing ---
        document.getElementById('pdfUpload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    uploadedDocs.push({ 
                        name: file.name, 
                        text: fullText, 
                        assigned: true,
                        instructions: "" 
                    });
                    updateDocUI();
                } catch (err) {
                    alert("PDF Read Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function updateDocUI() {
            const list = document.getElementById('docList');
            list.innerHTML = uploadedDocs.map((doc, idx) => `
                <div class="flex flex-col gap-1 p-2 bg-gray-800/40 rounded border border-gray-700/50">
                    <div class="flex justify-between items-center text-[11px] text-white">
                        <div class="flex items-center gap-2 truncate">
                            <input type="checkbox" ${doc.assigned ? 'checked' : ''} onclick="toggleAssign(${idx})" class="accent-blue-500">
                            <span class="truncate w-32 font-bold"><i class="fas fa-file-pdf text-red-500 mr-1"></i>${doc.name}</span>
                        </div>
                        <div class="flex gap-2">
                            <i class="fas fa-cog text-gray-500 hover:text-blue-400 cursor-pointer" title="Instructions" onclick="openInstrModal(${idx})"></i>
                            <i class="fas fa-trash-alt text-gray-500 hover:text-red-500 cursor-pointer" onclick="removeDoc(${idx})"></i>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-[10px] text-gray-600 text-center italic py-2">No files active</p>';
        }

        function toggleAssign(idx) { uploadedDocs[idx].assigned = !uploadedDocs[idx].assigned; }
        function removeDoc(idx) { uploadedDocs.splice(idx, 1); updateDocUI(); }

        // --- Instructions ---
        function openInstrModal(idx) {
            currentInstrIdx = idx;
            document.getElementById('instrFileName').innerText = uploadedDocs[idx].name;
            document.getElementById('instrText').value = uploadedDocs[idx].instructions || "";
            document.getElementById('instrModal').classList.remove('hidden');
        }
        function closeInstrModal() { document.getElementById('instrModal').classList.add('hidden'); }
        function saveInstructions() {
            if(currentInstrIdx !== -1) uploadedDocs[currentInstrIdx].instructions = document.getElementById('instrText').value;
            closeInstrModal();
        }

        // --- Voice Logic (Stop on re-click) ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isListening = true;
                document.getElementById('voiceInputBtn').classList.add('text-green-500', 'animate-pulse');
            };

            recognition.onend = () => {
                isListening = false;
                document.getElementById('voiceInputBtn').classList.remove('text-green-500', 'animate-pulse');
            };

            recognition.onresult = (e) => {
                let final_transcript = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) {
                    if (e.results[i].isFinal) final_transcript += e.results[i][0].transcript;
                }
                if(final_transcript) document.getElementById('mainInput').value += final_transcript;
            };
        }

        document.getElementById('voiceInputBtn').onclick = () => {
            if (!recognition) return alert("Browser not supported");
            if (isListening) recognition.stop(); else recognition.start();
        };

        // --- Chat ---
        function setMode(btn, mode) {
            document.querySelectorAll('.response-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            config.mode = mode;
        }

        function appendMsg(sender, text, modeUsed = null) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex flex-col ${sender === 'User' ? 'items-end' : 'items-start'} mb-4 cursor-pointer animate-fadeIn`;
            div.onclick = () => {
                div.classList.toggle('msg-selected');
                div.classList.contains('msg-selected') ? selectedMessages.add(id) : selectedMessages.delete(id);
            };

            div.innerHTML = `
                <div class="${sender === 'User' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-100'} p-3 px-4 rounded-2xl max-w-[85%] shadow-lg border border-white/5">
                    <p class="text-[8px] font-bold opacity-40 uppercase mb-1 tracking-widest">${sender}</p>
                    <div class="text-sm leading-relaxed">${text}</div>
                    ${sender === 'AI' ? `
                        <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center text-[8px] uppercase font-bold text-gray-500">
                            <span class="bg-gray-900/50 px-2 py-0.5 rounded">MODE: ${modeUsed || config.mode}</span>
                            <i class="fas fa-volume-up cursor-pointer hover:text-blue-400 text-xs px-2" onclick="readText('${text.replace(/'/g, "\\'")}'); event.stopPropagation();"></i>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('chatWindow').appendChild(div);
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
        }

        async function handleChat() {
            const input = document.getElementById('mainInput');
            const prompt = input.value.trim();
            if (!prompt || !config.apiKey) return;

            if (isListening) recognition.stop();
            appendMsg('User', prompt);
            input.value = '';

            const assignedText = uploadedDocs.filter(d => d.assigned).map(d => 
                `FILE: ${d.name}\nINSTRUCTIONS: ${d.instructions}\nCONTENT: ${d.text}`
            ).join('\n\n');
            
            const loaderId = 'loader-' + Date.now();
            const loader = document.createElement('div');
            loader.id = loaderId;
            loader.className = 'text-[10px] text-blue-400 italic animate-pulse ml-4 mb-4';
            loader.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>AI is processing...';
            document.getElementById('chatWindow').appendChild(loader);

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${config.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "model": config.modelId,
                        "messages": [
                            { "role": "system", "content": `You are AI Mind Pro. Response Language MUST match User Language. Mode: ${config.mode}. Use provided context strictly for DOC mode. Context: ${assignedText}` },
                            { "role": "user", "content": prompt }
                        ]
                    })
                });
                const data = await response.json();
                document.getElementById(loaderId).remove();
                if (data.choices?.[0]) appendMsg('AI', data.choices[0].message.content, config.mode);
            } catch (err) {
                if(document.getElementById(loaderId)) document.getElementById(loaderId).remove();
                appendMsg('Error', "API Connection Failed.");
            }
        }

        function readText(txt) {
            window.speechSynthesis.cancel();
            const speech = new SpeechSynthesisUtterance(txt);
            speech.lang = /[અ-હ]/.test(txt) ? 'gu-IN' : (/[अ-ह]/.test(txt) ? 'hi-IN' : 'en-US');
            window.speechSynthesis.speak(speech);
        }

        document.getElementById('apiToggleBtn').onclick = () => document.getElementById('apiSettingsPanel').classList.toggle('hidden');
        document.getElementById('saveConfig').onclick = () => {
            config.apiKey = document.getElementById('apiKeyInput').value;
            config.modelId = document.getElementById('modelSelect').value;
            localStorage.setItem('or_key', config.apiKey);
            localStorage.setItem('or_model', config.modelId);
            document.getElementById('apiSettingsPanel').classList.add('hidden');
        };

        document.getElementById('deleteSelected').onclick = () => {
            selectedMessages.forEach(id => document.getElementById(id).remove());
            selectedMessages.clear();
        };

        document.getElementById('sendBtn').onclick = handleChat;
        document.getElementById('mainInput').onkeydown = (e) => { if(e.key === 'Enter') handleChat(); };
    </script>
</body>
</html>
