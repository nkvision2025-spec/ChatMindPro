<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI MIND PRO - Multilingual Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0b1120; color: #94a3b8; font-family: sans-serif; }
        .sidebar { background-color: #0f172a; border-right: 1px solid #1e293b; width: 320px; }
        .card { background-color: #111827; border: 1px solid #1e293b; border-radius: 12px; }
        .input-dark { background-color: #020617; border: 1px solid #1e293b; color: #f8fafc; }
        .btn-primary { background-color: #3b82f6; color: white; transition: all 0.3s; }
        .response-mode-btn.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .msg-selected { border: 2px solid #3b82f6 !important; background: rgba(59, 130, 246, 0.05); }
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside class="sidebar flex flex-col p-4 overflow-y-auto">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-2 rounded-lg text-white"><i class="fas fa-brain"></i></div>
                <h1 class="text-xl font-bold text-white tracking-tight">AI MIND PRO</h1>
            </div>
            <button class="text-[10px] font-bold text-red-500 border border-red-500/30 px-3 py-1 rounded">LOGOUT</button>
        </div>

        <!-- API Settings Toggle -->
        <div id="apiToggleBtn" class="border border-gray-700 rounded-full py-2 px-4 mb-4 text-center cursor-pointer hover:bg-gray-800 text-blue-400 font-bold text-xs uppercase">
            <i class="fas fa-key mr-2"></i> API Settings
        </div>

        <div id="apiSettingsPanel" class="hidden mb-6 p-4 card space-y-3">
            <div>
                <label class="text-[10px] text-gray-400 block mb-1 uppercase">OpenRouter Key</label>
                <input type="password" id="apiKeyInput" class="input-dark w-full p-2 text-sm rounded outline-none">
            </div>
            <div>
                <label class="text-[10px] text-gray-400 block mb-1 uppercase">Model Selection</label>
                <select id="modelSelect" class="input-dark w-full p-2 text-sm rounded outline-none">
                    <option value="google/gemini-2.0-flash-001">Gemini 2.0 Flash (Fastest)</option>
                    <option value="qwen/qwen-2.5-72b-instruct:free">Qwen 2.5 72B (Free)</option>
                </select>
            </div>
            <button id="saveConfig" class="w-full text-xs font-bold py-2 bg-blue-600 text-white rounded uppercase">Save Settings</button>
        </div>

        <!-- Admin Management (Newly Added) -->
        <div class="mb-6">
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 flex items-center gap-2">
                <i class="fas fa-user-shield"></i> User Management
            </p>
            <div class="card p-3 space-y-2">
                <input type="text" id="adminUserId" placeholder="Admin ID" class="input-dark w-full p-2 text-[11px] rounded outline-none">
                <input type="password" id="adminUserPass" placeholder="Password" class="input-dark w-full p-2 text-[11px] rounded outline-none">
                <button class="w-full py-1.5 bg-gray-800 text-gray-300 text-[10px] font-bold rounded hover:bg-gray-700 uppercase">Update Auth</button>
            </div>
        </div>

        <!-- Add Document Section -->
        <div class="mb-6">
            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3">Add & Assign Documents</p>
            <div class="card p-4 border-dashed border-gray-700 flex flex-col items-center">
                <input type="file" id="pdfUpload" accept=".pdf" class="hidden">
                <label for="pdfUpload" class="cursor-pointer text-center">
                    <i class="fas fa-file-pdf text-3xl text-red-500 mb-2"></i>
                    <p class="text-[10px] text-gray-400">PDF Upload & Read</p>
                </label>
            </div>
        </div>

        <!-- Active Documents List with Assign Checkbox -->
        <div>
            <p class="text-[10px] text-gray-400 uppercase font-bold mb-2">Active Documents</p>
            <div class="card p-3 space-y-2" id="docList">
                <p class="text-[10px] text-gray-600 text-center italic">No documents uploaded</p>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col">
        <nav class="h-16 flex items-center justify-between px-6 border-b border-gray-800">
            <div class="flex items-center gap-4">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-500 uppercase">Status</span>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500"></div>
                        <span id="activeUserDisplay" class="text-sm font-bold text-white uppercase tracking-wider">ADMIN</span>
                    </div>
                </div>
                
                <!-- Response Modes -->
                <div class="flex gap-1 bg-gray-900 p-1 rounded-lg ml-6">
                    <button class="response-mode-btn active text-[10px] px-4 py-1.5 rounded font-bold transition uppercase" onclick="setMode(this, 'DOC')">DOC</button>
                    <button class="response-mode-btn text-[10px] px-4 py-1.5 rounded text-gray-500 font-bold hover:text-white transition uppercase" onclick="setMode(this, 'WEB')">WEB</button>
                    <button class="response-mode-btn text-[10px] px-4 py-1.5 rounded text-gray-500 font-bold hover:text-white transition uppercase" onclick="setMode(this, 'BOTH')">BOTH</button>
                </div>

                <button id="deleteSelected" class="ml-4 bg-red-900/10 text-red-500 border border-red-500/20 text-[10px] font-bold px-3 py-1.5 rounded uppercase hover:bg-red-500 hover:text-white transition">Delete Chat</button>
            </div>
        </nav>

        <!-- Chat Area -->
        <div id="chatWindow" class="flex-1 overflow-y-auto p-8 flex flex-col gap-6">
            <div class="text-center p-10 opacity-50">
                <i class="fas fa-microchip text-4xl mb-4"></i>
                <p class="text-sm">AI Mind Pro Ready. Please upload a PDF and set Mode.</p>
            </div>
        </div>

        <!-- Input Section -->
        <div class="p-6">
            <div class="max-w-4xl mx-auto chat-input-container p-2 flex items-center gap-4 px-4 shadow-2xl bg-gray-900/50">
                <button id="voiceInputBtn" class="text-gray-500 hover:text-blue-500 transition text-lg px-2">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" id="mainInput" placeholder="તમારો સવાલ અહીં લખો..." class="flex-1 bg-transparent border-none outline-none text-white text-sm py-2">
                <button id="sendBtn" class="bg-blue-600 w-10 h-10 rounded-full flex items-center justify-center text-white hover:bg-blue-500 transition shadow-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let config = {
            apiKey: localStorage.getItem('or_key') || '',
            modelId: localStorage.getItem('or_model') || 'google/gemini-2.0-flash-001',
            mode: 'DOC'
        };

        let uploadedDocs = []; 
        let selectedMessages = new Set();
        let recognition;

        // --- PDF Processing ---
        document.getElementById('pdfUpload').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function() {
                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                    }
                    uploadedDocs.push({ name: file.name, text: fullText, assigned: true });
                    updateDocUI();
                } catch (err) {
                    alert("PDF Read Error: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function updateDocUI() {
            const list = document.getElementById('docList');
            list.innerHTML = uploadedDocs.map((doc, idx) => `
                <div class="flex justify-between items-center text-[11px] text-white bg-gray-800/50 p-2 rounded border border-gray-700">
                    <div class="flex items-center gap-2 truncate">
                        <input type="checkbox" ${doc.assigned ? 'checked' : ''} onclick="toggleAssign(${idx})" class="accent-blue-500">
                        <span class="truncate w-32"><i class="fas fa-file-pdf text-red-400 mr-1"></i>${doc.name}</span>
                    </div>
                    <i class="fas fa-times text-gray-500 hover:text-red-500 cursor-pointer p-1" onclick="removeDoc(${idx})"></i>
                </div>
            `).join('') || '<p class="text-[10px] text-gray-600 text-center italic">No documents uploaded</p>';
        }

        function toggleAssign(idx) { uploadedDocs[idx].assigned = !uploadedDocs[idx].assigned; }
        function removeDoc(idx) { uploadedDocs.splice(idx, 1); updateDocUI(); }

        // --- Voice Logic ---
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.lang = 'gu-IN';
            recognition.onstart = () => document.getElementById('voiceInputBtn').classList.add('text-green-500');
            recognition.onend = () => document.getElementById('voiceInputBtn').classList.remove('text-green-500');
            recognition.onresult = (e) => { document.getElementById('mainInput').value = e.results[0][0].transcript; };
        }
        document.getElementById('voiceInputBtn').onclick = () => { recognition && recognition.start(); };

        // --- Chat Logic ---
        function setMode(btn, mode) {
            document.querySelectorAll('.response-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            config.mode = mode;
        }

        function appendMsg(sender, text, modeUsed = null) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = `flex flex-col ${sender === 'User' ? 'items-end' : 'items-start'} mb-4 cursor-pointer`;
            div.onclick = () => {
                div.classList.toggle('msg-selected');
                div.classList.contains('msg-selected') ? selectedMessages.add(id) : selectedMessages.delete(id);
            };

            div.innerHTML = `
                <div class="${sender === 'User' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-100'} p-3 px-4 rounded-2xl max-w-[85%] shadow-md">
                    <p class="text-[8px] font-bold opacity-40 uppercase mb-1">${sender}</p>
                    <div class="text-sm leading-relaxed">${text}</div>
                    ${sender === 'AI' ? `
                        <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center text-[8px] uppercase font-bold text-gray-500">
                            <span>MODE: ${modeUsed || config.mode}</span>
                            <i class="fas fa-volume-up cursor-pointer hover:text-blue-400 text-xs" onclick="readText('${text.replace(/'/g, "\\'")}'); event.stopPropagation();"></i>
                        </div>
                    ` : ''}
                </div>
            `;
            document.getElementById('chatWindow').appendChild(div);
            document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
        }

        async function handleChat() {
            const input = document.getElementById('mainInput');
            const prompt = input.value.trim();
            if (!prompt) return;
            if (!config.apiKey) { alert("Please set API Key in Settings!"); return; }

            appendMsg('User', prompt);
            input.value = '';

            // Context from assigned docs
            const assignedText = uploadedDocs.filter(d => d.assigned).map(d => d.text).join('\n\n');
            
            const loader = document.createElement('div');
            loader.className = 'text-[10px] text-blue-400 italic animate-pulse ml-4 mb-4';
            loader.innerText = 'AI is thinking...';
            document.getElementById('chatWindow').appendChild(loader);

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${config.apiKey}`, 
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "AI Mind Pro"
                    },
                    body: JSON.stringify({
                        "model": config.modelId,
                        "messages": [
                            { "role": "system", "content": `You are AI Mind Pro. Language: Match User Query (Gujarati/Hindi/English). Mode: ${config.mode}. If mode is DOC/BOTH, use this Context: ${assignedText}` },
                            { "role": "user", "content": prompt }
                        ]
                    })
                });
                
                const data = await response.json();
                loader.remove();
                
                if (data.choices && data.choices[0]) {
                    appendMsg('AI', data.choices[0].message.content, config.mode);
                } else {
                    throw new Error(data.error?.message || "Response error");
                }
            } catch (err) {
                loader.remove();
                appendMsg('Error', "Error: " + err.message);
            }
        }

        function readText(txt) {
            const speech = new SpeechSynthesisUtterance(txt);
            speech.lang = /[અ-હ]/.test(txt) ? 'gu-IN' : (/[अ-ह]/.test(txt) ? 'hi-IN' : 'en-US');
            window.speechSynthesis.speak(speech);
        }

        document.getElementById('apiToggleBtn').onclick = () => document.getElementById('apiSettingsPanel').classList.toggle('hidden');
        document.getElementById('saveConfig').onclick = () => {
            config.apiKey = document.getElementById('apiKeyInput').value.trim();
            config.modelId = document.getElementById('modelSelect').value;
            localStorage.setItem('or_key', config.apiKey);
            localStorage.setItem('or_model', config.modelId);
            document.getElementById('apiSettingsPanel').classList.add('hidden');
            alert("Settings Saved Successfully!");
        };

        document.getElementById('deleteSelected').onclick = () => {
            selectedMessages.forEach(id => document.getElementById(id).remove());
            selectedMessages.clear();
        };

        document.getElementById('sendBtn').onclick = handleChat;
        document.getElementById('mainInput').onkeydown = (e) => { if(e.key === 'Enter') handleChat(); };
    </script>
</body>
</html>
